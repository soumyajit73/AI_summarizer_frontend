<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuore AI | Medical Records OCR</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #0ca39a;
            --primary-dark: #088a82;
            --bg-light: #f8fafc;
            --text-dark: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background: white;
            padding: 1.2rem 5%;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .logo i {
            color: white;
            background: var(--primary);
            padding: 8px;
            border-radius: 8px;
        }

        main {
            flex: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 20px;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 2rem;
        }

        .hero-text {
            grid-column: 1 / -1;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .hero-text h1 { font-size: 2rem; margin-bottom: 8px; }

        .card {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
        }

        .upload-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 2rem 1rem;
            text-align: center;
            background: #fdfdfd;
            cursor: pointer;
            transition: 0.2s;
        }

        .upload-zone:hover { border-color: var(--primary); background: #f0fdfa; }
        .upload-zone i { font-size: 2rem; color: var(--primary); margin-bottom: 0.5rem; }
        .file-input { display: none; }

        #file-count {
            margin-top: 10px;
            font-weight: 600;
            color: var(--primary);
            display: none;
            text-align: center;
        }

        .btn-container { display: flex; gap: 1rem; margin-top: 1.5rem; }

        button {
            padding: 0.75rem 1.2rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            transition: 0.2s;
            justify-content: center;
        }

        #btn { background: #cbd5e1; color: white; flex: 2; }
        #btn.active { background: var(--primary); }
        #btn:hover.active { background: var(--primary-dark); }
        #btn:disabled { cursor: not-allowed; opacity: 0.7; }

        .btn-clear { background: white; border: 1px solid var(--border); flex: 1; color: var(--text-dark); }

        /* Compact Output Section */
        .result-card { display: none; margin-top: 1.5rem; }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        .section-box {
            background: #f1f5f9;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .section-title {
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .output-list { margin: 0; padding: 0; list-style: none; font-size: 0.85rem; }
        .output-list li { margin-bottom: 4px; padding-left: 12px; position: relative; }
        .output-list li::before { content: "â€¢"; position: absolute; left: 0; color: var(--primary); }

        .insight-box {
            grid-column: 1 / -1;
            background: #fffbeb;
            border: 1px solid #fef3c7;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            color: #92400e;
        }

        .disclaimer {
            background: #fffbeb;
            padding: 1.2rem;
            border-radius: 12px;
            font-size: 0.8rem;
            color: #92400e;
            height: fit-content;
        }

        #loading { display: none; text-align: center; margin-top: 1rem; color: var(--primary); font-weight: 600; }

        @media (max-width: 850px) {
            main { grid-template-columns: 1fr; }
            .summary-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

   <header>
    <div class="logo">
        <img src="cuore-logo-svg (1).svg" alt="Cuore AI Logo" style="height: 80px; width: auto; border-radius: 6px; object-fit: contain;">
        
        <div>
            Cuore AI 
            <span style="font-size: 0.7rem; font-weight: 800; display: block; color: var(--text-muted);">
                Medical Records Summarizer
            </span>
        </div>
    </div>
</header>

    <main>
        <div class="hero-text">
            <h1>AI Medical Records Summarizer</h1>
            <p>Upload prescriptions and let AI generate intelligent, structured summaries.</p>
        </div>
        

        <div class="left-col">
            <div class="card">
                <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                    <i class="fa-solid fa-cloud-arrow-up"></i>
                    <h3>Click to upload or drag and drop</h3>
                    <p style="color: var(--text-muted); font-size: 0.85rem;">Support for JPG, PNG </p>
                    <input type="file" id="fileInput" class="file-input" multiple accept="image/*" onchange="updateFileStatus()">
                </div>
                <div id="file-count"><i class="fa-solid fa-file-circle-check"></i> <span>0</span> files selected</div>
                <div style="margin-top: 1rem;">
    <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-muted);">
        Optional Custom Prompt
    </label>
    <textarea
        id="userPrompt"
        placeholder="Example: Focus more on medications and lab results. Ignore imaging if irrelevant."
        style="
            width: 100%;
            min-height: 70px;
            margin-top: 6px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 0.85rem;
            resize: vertical;
        "
    ></textarea>
</div>

                <div class="btn-container">
                    <button onclick="processDocuments()" id="btn"><i class="fa-solid fa-wand-sparkles"></i> Process Records</button>
                    <button onclick="location.reload()" class="btn-clear"><i class="fa-solid fa-trash"></i> Clear All</button>
                </div>

                <div id="loading"><i class="fa-solid fa-spinner fa-spin"></i> AI is analyzing... please wait</div>
            </div>
            

            <div id="result" class="card result-card">
                <h3 style="margin-top: 0; border-bottom: 1px solid var(--border); padding-bottom: 10px;">Clinical Summary</h3>
                <div class="summary-grid">
                    <div class="section-box">
                        <div class="section-title"><i class="fa-solid fa-history"></i> Past History</div>
                        <ul id="past_history" class="output-list"></ul>
                    </div>
                    <div class="section-box">
                        <div class="section-title"><i class="fa-solid fa-pills"></i> Medications</div>
                        <ul id="medications" class="output-list"></ul>
                    </div>
                    <div class="section-box">
                        <div class="section-title"><i class="fa-solid fa-flask"></i> Labs</div>
                        <ul id="labs" class="output-list"></ul>
                    </div>
                    <div class="section-box">
                        <div class="section-title"><i class="fa-solid fa-x-ray"></i> Imaging</div>
                        <ul id="imaging" class="output-list"></ul>
                    </div>
                    <div class="insight-box">
                        <strong>AI Insight:</strong> <span id="prediction"></span>
                    </div>
                </div>
            </div>
        </div>

        <aside class="disclaimer">
            <h4 style="margin-top: 0;"><i class="fa-solid fa-warning"></i> Disclaimer</h4>
            <ul style="padding-left: 15px; margin: 0;">
                <li style="margin-bottom: 8px;">Testing and demo purposes only.</li>
                <li style="margin-bottom: 8px;">Not for clinical diagnosis or treatment decisions.</li>
                <li style="margin-bottom: 8px;">OCR may contain errors; always verify.</li>
            </ul>
        </aside>
    </main>

    <script>
        const RENDER_URL = "https://main-c082c211-8fe2-40bb-bdce-e319a8b6ea13.lowcloud.co/upload-and-process";
        const userId = "standalone_" + Math.random().toString(36).substring(7);

        function updateFileStatus() {
            const files = document.getElementById('fileInput').files;
            const countEl = document.getElementById('file-count');
            const btn = document.getElementById('btn');
            
            if (files.length > 0) {
                countEl.style.display = 'block';
                countEl.querySelector('span').innerText = files.length;
                btn.classList.add('active');
            } else {
                countEl.style.display = 'none';
                btn.classList.remove('active');
            }
        }

        async function processDocuments() {
            const files = document.getElementById('fileInput').files;
            if (files.length === 0) return alert("Please select files first");

            document.getElementById('loading').style.display = "block";
            document.getElementById('btn').disabled = true;
            document.getElementById('result').style.display = "none";

            const formData = new FormData();
formData.append("user_id", userId); 

for (let i = 0; i < files.length; i++) {
    formData.append("files", files[i]);
}

// ðŸ‘‡ NEW: optional user prompt
const userPrompt = document.getElementById("userPrompt").value.trim();
if (userPrompt) {
    formData.append("prompt", userPrompt);
}


          try {
    const response = await fetch(RENDER_URL, { 
        method: "POST", 
        body: formData 
    });

    const data = await response.json();
    
    // âœ… FIX: Access summary directly from data if Python returns ai_data directly
 if (data && data.summary) {
    displayResults(data.summary, data.prediction?.message);

    // ðŸ‘‡ Handle unstructured AI output
    if (
        data.meta?.mode === "unstructured" &&
        data.prediction?.message
    ) {
        document.getElementById("result").style.display = "block";
        document.getElementById("prediction").innerText =
            data.prediction.message;
    }

} else {
    console.error("Unexpected response:", data);
    alert("Unexpected response from server");
}


} catch (error) {
    alert("Error: " + error.message);
} finally {
                document.getElementById('loading').style.display = "none";
                document.getElementById('btn').disabled = false;
            }
        }

        function displayResults(summary, predictionMessage) {
            document.getElementById('result').style.display = "block";

            const fillList = (id, items) => {
                const el = document.getElementById(id);
                const listItems = Array.isArray(items) ? items : [];
                el.innerHTML = listItems.length ? listItems.map(i => `<li>${i}</li>`).join('') : "<li>None found</li>";
            };

            // âœ… Map data directly to UI
            fillList('past_history', summary.past_history);
            fillList('medications', summary.medications);
            fillList('labs', summary.labs);
            fillList('imaging', summary.imaging);

            document.getElementById('prediction').innerText = predictionMessage || "Summarization complete.";
        }
    </script>
</body>
</html>